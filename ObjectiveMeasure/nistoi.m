function d = nistoi(x, y, fs_signal)
% -----------------------------------------------------------------------------%
%                               Inputs                                         %
% -----------------------------------------------------------------------------%
% x  : Clean speech signal (used only for VAD).
% y  : Noisy/processed signal.
% fs_signal : Common sampling frequency of the input signals [Hz].
%
% -----------------------------------------------------------------------------%
%                               Description                                    %
% -----------------------------------------------------------------------------%
% This is an implementation of the Non-Intrusive Short-Time Objective 
% Intelligibility (NI-STOI) measure as described in:
%
%   A. H. Andersen, J. M. de Haan, Z.-H. Tan, and J. Jensen, “A non-
%   intrusive Short-Time Objective Intelligibility measure,” IEEE 
%   International Conference on Acoustics, Speech and Signal Processing 
%   (ICASSP), March 2017. 
%
% - Asger Heidemann Andersen, 10/12-2016
%
% -----------------------------------------------------------------------------%
%                                   Licence                                    %
% -----------------------------------------------------------------------------%
% License Agreement for the NI-STOI software (the ”Software”)
% 
% By using the Software you agree to the below terms and conditions. If you do 
% not agree with such terms and conditions, do not use the software.
% 
% All title, copyrights and pending patents in and to the Software are owned by 
% Oticon A/S and/or Aalborg University (the “Owners”). 
% 
% The Software may only be used for non-commercial purposes such as research 
% undertaken by public or private institutions and/or universities. Hence, the 
% Software may not be used in the context of product development.
% 
% DISCLAIMER OF WARRANTIES: THE SOFTWARE IS BEING PROVIDED TO YOU "AS IS" 
% WITHOUT WARRANTY, UPGRADES OR SUPPORT OF ANY KIND. THE OWNERS EXPRESSLY 
% DISCLAIM ALL WARRANTIE WITH REGARD TO THE SOFTWARE, EXPRESS OR IMPLIED, 
% INCLUDING, WITHOUT LIMITATION, ANY IMPLIED WARRANTIES OF FITNESS FOR A 
% PARTICULAR PURPOSE, QUALITY, ACCURACY OR NON-INFRINGEMENT OF THIRD PARTY 
% RIGHTS. 
% 
% LIMITATION OF LIABILITY: IN NO EVENT THE OWNERS WILL BE LIABLE TO YOU FOR ANY 
% INCIDENTIAL, SPECIAL, INDIRECT, CONSEQUENTIAL, OR PUNITIVE DAMAGES ARISING 
% OUT OF OR IN CONNECTION WITH YOUR USE OF THE SOFTWARE, WHETHER UNDER A THEORY 
% OF CONTRACT, WARRANTY, TORT (INCLUDING NEGLIGENCE), PRODUCTS LIABILITY, OR 
% OTHERWISE, EVEN IF THE OWNERS HAVE BEEN ADVISED OF THE POSSIBILITY OF SUCH 
% DAMAGES. 

if length(x)~=length(y)
    error('x and y should have the same length');
end

% Initialization
x           = x(:);                             % clean speech column vector
y           = y(:);                             % processed speech column vector

fs          = 10000;                            % sample rate of proposed intelligibility measure
N_frame    	= 256;                              % window support
K           = 512;                              % FFT size
J           = 15;                               % Number of 1/3 octave bands
mn          = 150;                              % Center frequency of first 1/3 octave band in Hz.
H           = thirdoct(fs, K, J, mn);           % Get 1/3 octave band matrix
N           = 30;                               % Number of frames for intermediate intelligibility measure (Length analysis window)
dyn_range   = 40;                               % speech dynamic range
nc          = 1;                             	% number of principal components        

% Pure tone threshold filter coefficients w. thridoct weighting
b = [4.63223568447597e-07,3.95804763423376e-07,3.40416398152586e-07,4.90480621069467e-07,6.68540560585734e-07,7.81028680013174e-07,8.75920651313391e-07,1.01748741957954e-06,1.18421268357796e-06,1.35753870159808e-06,1.53965351342009e-06,1.73668963906151e-06,1.95067109891269e-06,2.18258286882111e-06,2.42921440776578e-06,2.69580602048840e-06,2.98044288584707e-06,3.28351867743714e-06,3.60779264056525e-06,3.95376952087341e-06,4.32092128520547e-06,4.71454621721768e-06,5.13294664889275e-06,5.57491810312488e-06,6.04473868918290e-06,6.54486209032411e-06,7.07466618629234e-06,7.63642607466816e-06,8.23039263197709e-06,8.85819498408318e-06,9.52291135828751e-06,1.02251394490452e-05,1.09661530084539e-05,1.17486288330480e-05,1.25736413314098e-05,1.34416349256600e-05,1.43569760550047e-05,1.53203619024355e-05,1.63321322901544e-05,1.73960578819190e-05,1.85136821566292e-05,1.96860629759823e-05,2.09158332301259e-05,2.22029023210556e-05,2.35515355945801e-05,2.49625527183285e-05,2.64388119248411e-05,2.79825228039093e-05,2.95950196915335e-05,3.12791893225816e-05,3.30345767158884e-05,3.48690564659730e-05,3.67773938539164e-05,3.87672612016679e-05,4.08383190645280e-05,4.29940870979890e-05,4.52381644429392e-05,4.75682926501095e-05,4.99904754323671e-05,5.25071474474778e-05,5.51182526506706e-05,5.78303179199120e-05,6.06412363845543e-05,6.35542092867484e-05,6.65769237982221e-05,6.97075223923519e-05,7.29452172828159e-05,7.63002609421171e-05,7.97724423068562e-05,8.33612290335967e-05,8.70729453885824e-05,9.09095701164118e-05,9.48696053619620e-05,9.89618472734489e-05,0.000103189116333718,0.000107547700624995,0.000112043573870822,0.000116683905733352,0.000121465777208754,0.000126391204207258,0.000131467431986651,0.000136697533335933,0.000142081719303346,0.000147622366433250,0.000153324691147885,0.000159194254998620,0.000165227976659995,0.000171428085712266,0.000177803539711709,0.000184357126590935,0.000191087510482159,0.000198000203478090,0.000205098824185154,0.000212384729532196,0.000219862677124480,0.000227536466716943,0.000235404214905072,0.000243475101804598,0.000251749683802402,0.000260232443346237,0.000268924104380759,0.000277827852415613,0.000286946083570595,0.000296284954716766,0.000305846726935474,0.000315631769995254,0.000325645868801282,0.000335889040272034,0.000346363408554798,0.000357076249226131,0.000368027802902966,0.000379221423881524,0.000390655830964727,0.000402336027321133,0.000414266306563451,0.000426446425393675,0.000438876026308649,0.000451561610239731,0.000464504653200045,0.000477705540396710,0.000491164783668493,0.000504884519727757,0.000518866128525178,0.000533112592016642,0.000547625706691059,0.000562406674216167,0.000577455538206665,0.000592775467484733,0.000608366475260337,0.000624229145723395,0.000640363461529544,0.000656775795182693,0.000673464296720971,0.000690426745725994,0.000707665914126946,0.000725184524498427,0.000742979785261316,0.000761054896218770,0.000779408244800082,0.000798039429815064,0.000816951419713172,0.000836142269671092,0.000855607078563403,0.000875356266747647,0.000895381728594042,0.000915678021435756,0.000936248034263464,0.000957097490757732,0.000978218446812753,0.000999608888377018,0.00102126561282083,0.00104318673155324,0.00106537809792895,0.00108783270261424,0.00111054208015476,0.00113351055133600,0.00115673235660786,0.00118020575582907,0.00120392777981002,0.00122789161264948,0.00125209013721148,0.00127653539242743,0.00130120910308814,0.00132609834123171,0.00135121249321649,0.00137654766048417,0.00140208910370767,0.00142783196455332,0.00145377080871331,0.00147990557694528,0.00150622578868854,0.00153272085768705,0.00155938652394322,0.00158622361433310,0.00161321770909050,0.00164036298643406,0.00166764990658087,0.00169507419157054,0.00172262413811552,0.00175029285672437,0.00177806782539621,0.00180594753737917,0.00183391927363745,0.00186196777364870,0.00189008780270213,0.00191827074001897,0.00194650147718131,0.00197477844367474,0.00200307023770511,0.00203137076909630,0.00205968494982095,0.00208799728356797,0.00211626710419934,0.00214449815325440,0.00217268540983739,0.00220081817477120,0.00222886866014102,0.00225681925463488,0.00228467594364424,0.00231241774431644,0.00234001852588666,0.00236748981321033,0.00239480760680207,0.00242195279631305,0.00244890858626707,0.00247567023620154,0.00250221354064148,0.00252855520050762,0.00255464636256791,0.00258047337463633,0.00260604407981344,0.00263132838933498,0.00265628769528043,0.00268092526308689,0.00270520804488653,0.00272913788468673,0.00275274644788028,0.00277596296827884,0.00279870985556400,0.00282109795805551,0.00284305967803870,0.00286454227944494,0.00288557100985247,0.00290613022665734,0.00292619268733173,0.00294578020838621,0.00296477196987528,0.00298325035159109,0.00300127460624396,0.00301867133685430,0.00303540120883443,0.00305163821866788,0.00306729290389745,0.00308227908239600,0.00309659592825259,0.00311031735407959,0.00312328085682532,0.00313565709293447,0.00314724041596896,0.00315815484979807,0.00316840360834303,0.00317787069060462,0.00318639678504576,0.00319386718433644,0.00320077390423438,0.00320896109489148,0.00321634388444806,0.00321853480481436,0.00321665666486592,0.00322655014883679,0.00326035823410413,0.00322655014883679,0.00321665666486592,0.00321853480481436,0.00321634388444806,0.00320896109489148,0.00320077390423438,0.00319386718433644,0.00318639678504576,0.00317787069060462,0.00316840360834303,0.00315815484979807,0.00314724041596896,0.00313565709293447,0.00312328085682532,0.00311031735407959,0.00309659592825259,0.00308227908239600,0.00306729290389745,0.00305163821866788,0.00303540120883443,0.00301867133685430,0.00300127460624396,0.00298325035159109,0.00296477196987528,0.00294578020838621,0.00292619268733173,0.00290613022665734,0.00288557100985247,0.00286454227944494,0.00284305967803870,0.00282109795805551,0.00279870985556400,0.00277596296827884,0.00275274644788028,0.00272913788468673,0.00270520804488653,0.00268092526308689,0.00265628769528043,0.00263132838933498,0.00260604407981344,0.00258047337463633,0.00255464636256791,0.00252855520050762,0.00250221354064148,0.00247567023620154,0.00244890858626707,0.00242195279631305,0.00239480760680207,0.00236748981321033,0.00234001852588666,0.00231241774431644,0.00228467594364424,0.00225681925463488,0.00222886866014102,0.00220081817477120,0.00217268540983739,0.00214449815325440,0.00211626710419934,0.00208799728356797,0.00205968494982095,0.00203137076909630,0.00200307023770511,0.00197477844367474,0.00194650147718131,0.00191827074001897,0.00189008780270213,0.00186196777364870,0.00183391927363745,0.00180594753737917,0.00177806782539621,0.00175029285672437,0.00172262413811552,0.00169507419157054,0.00166764990658087,0.00164036298643406,0.00161321770909050,0.00158622361433310,0.00155938652394322,0.00153272085768705,0.00150622578868854,0.00147990557694528,0.00145377080871331,0.00142783196455332,0.00140208910370767,0.00137654766048417,0.00135121249321649,0.00132609834123171,0.00130120910308814,0.00127653539242743,0.00125209013721148,0.00122789161264948,0.00120392777981002,0.00118020575582907,0.00115673235660786,0.00113351055133600,0.00111054208015476,0.00108783270261424,0.00106537809792895,0.00104318673155324,0.00102126561282083,0.000999608888377018,0.000978218446812753,0.000957097490757732,0.000936248034263464,0.000915678021435756,0.000895381728594042,0.000875356266747647,0.000855607078563403,0.000836142269671092,0.000816951419713172,0.000798039429815064,0.000779408244800082,0.000761054896218770,0.000742979785261316,0.000725184524498427,0.000707665914126946,0.000690426745725994,0.000673464296720971,0.000656775795182693,0.000640363461529544,0.000624229145723395,0.000608366475260337,0.000592775467484733,0.000577455538206665,0.000562406674216167,0.000547625706691059,0.000533112592016642,0.000518866128525178,0.000504884519727757,0.000491164783668493,0.000477705540396710,0.000464504653200045,0.000451561610239731,0.000438876026308649,0.000426446425393675,0.000414266306563451,0.000402336027321133,0.000390655830964727,0.000379221423881524,0.000368027802902966,0.000357076249226131,0.000346363408554798,0.000335889040272034,0.000325645868801282,0.000315631769995254,0.000305846726935474,0.000296284954716766,0.000286946083570595,0.000277827852415613,0.000268924104380759,0.000260232443346237,0.000251749683802402,0.000243475101804598,0.000235404214905072,0.000227536466716943,0.000219862677124480,0.000212384729532196,0.000205098824185154,0.000198000203478090,0.000191087510482159,0.000184357126590935,0.000177803539711709,0.000171428085712266,0.000165227976659995,0.000159194254998620,0.000153324691147885,0.000147622366433250,0.000142081719303346,0.000136697533335933,0.000131467431986651,0.000126391204207258,0.000121465777208754,0.000116683905733352,0.000112043573870822,0.000107547700624995,0.000103189116333718,9.89618472734489e-05,9.48696053619620e-05,9.09095701164118e-05,8.70729453885824e-05,8.33612290335967e-05,7.97724423068562e-05,7.63002609421171e-05,7.29452172828159e-05,6.97075223923519e-05,6.65769237982221e-05,6.35542092867484e-05,6.06412363845543e-05,5.78303179199120e-05,5.51182526506706e-05,5.25071474474778e-05,4.99904754323671e-05,4.75682926501095e-05,4.52381644429392e-05,4.29940870979890e-05,4.08383190645280e-05,3.87672612016679e-05,3.67773938539164e-05,3.48690564659730e-05,3.30345767158884e-05,3.12791893225816e-05,2.95950196915335e-05,2.79825228039093e-05,2.64388119248411e-05,2.49625527183285e-05,2.35515355945801e-05,2.22029023210556e-05,2.09158332301259e-05,1.96860629759823e-05,1.85136821566292e-05,1.73960578819190e-05,1.63321322901544e-05,1.53203619024355e-05,1.43569760550047e-05,1.34416349256600e-05,1.25736413314098e-05,1.17486288330480e-05,1.09661530084539e-05,1.02251394490452e-05,9.52291135828751e-06,8.85819498408318e-06,8.23039263197709e-06,7.63642607466816e-06,7.07466618629234e-06,6.54486209032411e-06,6.04473868918290e-06,5.57491810312488e-06,5.13294664889275e-06,4.71454621721768e-06,4.32092128520547e-06,3.95376952087341e-06,3.60779264056525e-06,3.28351867743714e-06,2.98044288584707e-06,2.69580602048840e-06,2.42921440776578e-06,2.18258286882111e-06,1.95067109891269e-06,1.73668963906151e-06,1.53965351342009e-06,1.35753870159808e-06,1.18421268357796e-06,1.01748741957954e-06,8.75920651313391e-07,7.81028680013174e-07,6.68540560585734e-07,4.90480621069467e-07,3.40416398152586e-07,3.95804763423376e-07,4.63223568447597e-07];

% resample signals if other samplerate is used than fs
if fs_signal ~= fs
    x	= resample(x, fs, fs_signal);
    y 	= resample(y, fs, fs_signal);
end

% Add internal noise
y = y + 10^(4/20)*filter(b,1,randn(size(y)));

% remove silent frames
[x y] = removeSilentFrames(x, y, dyn_range, N_frame, N_frame/2);

% apply 1/3 octave band TF-decomposition
y_hat     	= stdft(y, N_frame, N_frame/2, K); 	% apply short-time DFT to processed speech
y_hat       = y_hat(:, 1:(K/2+1)).';        	% take processed single-sided spectrum
Y           = zeros(J, size(y_hat, 2));         % init memory for processed speech 1/3 octave band TF-representation 

for i = 1:size(y_hat, 2)
    Y(:, i)	= sqrt(H*abs(y_hat(:, i)).^2);
end

% Loop all segments of length N and obtain intermediate intelligibility measure for all TF-regions
d_interm  	= zeros(J, length(N:size(Y, 2)));                               % init memory for intermediate intelligibility measure

% Load principal components
load('principal_components.mat', 'pc');

for m = N:size(Y, 2)
    % Noisy envelope segment
    Y_seg  	= Y(:, (m-N+1):m);   
    
    % Transform noisy envelopes with FFT
    Y_seg_fft = fft(Y_seg, [], 2);
    
    % Estimate clean envelop with principal components
    X_seg_est = zeros(size(Y_seg_fft));
    
    for i=1:nc
        X_seg_est = X_seg_est + pc(:,:,i) * sum(reshape(abs(Y_seg_fft) .* pc(:,:,i),[1,450])); 
    end
    X_seg_est = ifft(X_seg_est.*exp(1j*angle(Y_seg_fft)), [], 2);
    for j = 1:J
        d_interm(j, m-N+1)  = taa_corr(X_seg_est(j, :).', Y_seg(j, :)');          % obtain correlation coeffecient from Eq.(4) [1]
    end
end

d_interm(isnan(d_interm)) = 0;
d = real(mean(d_interm(:)));                                                      % combine all intermediate intelligibility measures as in Eq.(4) [1]

%%
function  [A cf] = thirdoct(fs, N_fft, numBands, mn)
%   [A CF] = THIRDOCT(FS, N_FFT, NUMBANDS, MN) returns 1/3 octave band matrix
%   inputs:
%       FS:         samplerate 
%       N_FFT:      FFT size
%       NUMBANDS:   number of bands
%       MN:         center frequency of first 1/3 octave band
%   outputs:
%       A:          octave band matrix
%       CF:         center frequencies

f               = linspace(0, fs, N_fft+1);
f               = f(1:(N_fft/2+1));
k               = 0:(numBands-1); 
cf              = 2.^(k/3)*mn;
fl              = sqrt((2.^(k/3)*mn).*2.^((k-1)/3)*mn);
fr              = sqrt((2.^(k/3)*mn).*2.^((k+1)/3)*mn);
A               = zeros(numBands, length(f));

for i = 1:(length(cf))
    [a b]                   = min((f-fl(i)).^2);
    fl(i)                   = f(b);
    fl_ii                   = b;

	[a b]                   = min((f-fr(i)).^2);
    fr(i)                   = f(b);
    fr_ii                   = b;
    A(i,fl_ii:(fr_ii-1))	= 1;
end

rnk         = sum(A, 2);
numBands  	= find((rnk(2:end)>=rnk(1:(end-1))) & (rnk(2:end)~=0)~=0, 1, 'last' )+1;
A           = A(1:numBands, :);
cf          = cf(1:numBands);

%%
function x_stdft = stdft(x, N, K, N_fft)
%   X_STDFT = X_STDFT(X, N, K, N_FFT) returns the short-time
%	hanning-windowed dft of X with frame-size N, overlap K and DFT size
%   N_FFT. The columns and rows of X_STDFT denote the frame-index and
%   dft-bin index, respectively.

frames      = 1:K:(length(x)-N);
x_stdft     = zeros(length(frames), N_fft);

w           = hanning(N);
x           = x(:);

for i = 1:length(frames)
    ii              = frames(i):(frames(i)+N-1);
	x_stdft(i, :) 	= fft(x(ii).*w, N_fft);
end

%%
function rho = taa_corr(x, y)
%   RHO = TAA_CORR(X, Y) Returns correlation coeffecient between column
%   vectors x and y. Gives same results as 'corr' from statistics toolbox.
xn    	= x-mean(x);
xn  	= xn/sqrt(sum(xn.^2));
yn   	= y-mean(y);
yn    	= yn/sqrt(sum(yn.^2));
rho   	= sum(xn.*yn);

function [x_sil y_sil] = removeSilentFrames(x, y, range, N, K)
%   [X_SIL Y_SIL] = REMOVESILENTFRAMES(X, Y, RANGE, N, K) X and Y
%   are segmented with frame-length N and overlap K, where the maximum energy
%   of all frames of X is determined, say X_MAX. X_SIL and Y_SIL are the
%   reconstructed signals, excluding the frames, where the energy of a frame
%   of X is smaller than X_MAX-RANGE

x       = x(:);
y       = y(:);

frames  = 1:K:(length(x)-N);
w       = hanning(N);
msk     = zeros(size(frames));

for j = 1:length(frames)
    jj      = frames(j):(frames(j)+N-1);
    msk(j) 	= 20*log10(norm(x(jj).*w)./sqrt(N));
end

msk     = (msk-max(msk)+range)>0;
count   = 1;

x_sil   = zeros(size(x));
y_sil   = zeros(size(y));

for j = 1:length(frames)
    if msk(j)
        jj_i            = frames(j):(frames(j)+N-1);
        jj_o            = frames(count):(frames(count)+N-1);
        x_sil(jj_o)     = x_sil(jj_o) + x(jj_i).*w;
        y_sil(jj_o)  	= y_sil(jj_o) + y(jj_i).*w;
        count           = count+1;
    end
end

x_sil = x_sil(1:jj_o(end));
y_sil = y_sil(1:jj_o(end));